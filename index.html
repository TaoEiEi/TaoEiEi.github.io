<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Badminton Court Manager — v8 (Toast + Undo + Export/Import + Filters)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f172a;
      --muted:#94a3b8;
      --border:rgba(148,163,184,.18);
      --primary:#6366f1;
      --green:#10b981;
      --amber:#f59e0b;
      --danger:#ef4444;
      color-scheme: dark;
    }
    body{background:radial-gradient(1200px 800px at 10% -10%, rgba(99,102,241,.22), transparent 40%),radial-gradient(900px 700px at 80% -20%, rgba(16,185,129,.18), transparent 35%),var(--bg);min-height:100vh;color:#e5e7eb;}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 30px rgba(2,6,23,.25);}
    .soft{border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.02);}
    .title-grad{background:linear-gradient(90deg,#fff, #c7d2fe 55%, #a7f3d0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.55rem .9rem;border-radius:10px;border:1px solid var(--border);transition:.2s;background:rgba(255,255,255,.02);}
    .btn:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(2,6,23,.2);}
    .btn-primary{background:linear-gradient(180deg, rgba(99,102,241,.2), rgba(99,102,241,.1));border-color:rgba(99,102,241,.35);}
    .btn-green{background:linear-gradient(180deg, rgba(16,185,129,.22), rgba(16,185,129,.12));border-color:rgba(16,185,129,.35);}
    .btn-ghost{background:transparent;}
    .badge{font-size:.7rem;padding:.2rem .5rem;border-radius:9999px;border:1px solid var(--border);color:#e2e8f0;}
    .status{padding:.25rem .6rem;border-radius:9999px;font-weight:600;font-size:.72rem;letter-spacing:.2px}
    .available{background:rgba(16,185,129,.14);color:#bbf7d0;border:1px solid rgba(16,185,129,.35)}
    .ready{background:rgba(99,102,241,.14);color:#c7d2fe;border:1px solid rgba(99,102,241,.35)}
    .playing{background:rgba(245,158,11,.16);color:#fde68a;border:1px solid rgba(245,158,11,.35)}
    .table th,.table td{border-bottom:1px solid var(--border)}
    .muted{color:var(--muted)}
    .divider{height:1px;background:var(--border)}
    .icon-btn{width:34px;height:34px;border-radius:10px;border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;background:rgba(255,255,255,.02)}
    .modal{background:rgba(2,6,23,.55);}
    .modal-card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));border:1px solid var(--border);border-radius:18px;backdrop-filter:blur(8px)}
    .slot{display:flex;align-items:center;gap:.5rem;border:1px dashed var(--border);border-radius:12px;padding:.45rem .6rem;background:rgba(255,255,255,.02)}
    .chip{display:inline-flex;align-items:center;gap:.45rem;border:1px solid var(--border);border-radius:9999px;padding:.22rem .6rem;background:rgba(255,255,255,.02);font-size:.8rem}
    .tag{font-size:.7rem;border:1px solid var(--border);border-radius:9999px;padding:.05rem .5rem;color:#cbd5e1;background:rgba(255,255,255,.02)}
    .heading{font-size:1rem;font-weight:700;letter-spacing:.3px}
    .subtle{font-size:.85rem;color:var(--muted)}
    .pair-box{border:1px dashed var(--border); border-radius:14px; padding:.75rem; background:rgba(255,255,255,.02)}
    .pair-title{font-size:.9rem;color:#c7d2fe;font-weight:700;letter-spacing:.2px}

    /* Dark select styling */
    select.soft{
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background: rgba(255,255,255,.02);
      color: #e5e7eb;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding-right: 2.25rem;
      background-image:
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path fill="%23c7d2fe" d="M5.23 7.21a.75.75 0 0 1 1.06.02L10 10.94l3.71-3.71a.75.75 0 1 1 1.06 1.06l-4.24 4.24a.75.75 0 0 1-1.06 0L5.21 8.29a.75.75 0 0 1 .02-1.08z"/></svg>');
      background-repeat: no-repeat;
      background-position: right .7rem center;
      background-size: 1rem;
    }
    select.soft:focus{ outline:none; box-shadow:0 0 0 2px rgba(99,102,241,.45); border-color:rgba(99,102,241,.55); }
    select.soft option{ background:#0f172a; color:#e5e7eb; }
    select.soft::-ms-expand{ display:none; }

    
    /* ===== Right Queue Slidebar (no-shift) ===== */
    :root{ --qsW: 320px; --headerH: 84px; --qsCollapsed: 96px; }
    .queue-slidebar{
      position: fixed; right: 0; top: var(--headerH);
      width: var(--qsW); z-index: 60;
    }
    .queue-slidebar .panel{
      border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none;
      box-shadow: -12px 0 24px rgba(0,0,0,.35);
    }
    .queue-slidebar .qs-header{ display:flex; align-items:center; justify-content:space-between; gap:.5rem; padding:.85rem 1rem; border-bottom:1px solid var(--border); }
    .queue-slidebar .qs-body{ padding:.75rem; }
    .queue-slidebar .qs-list{ max-height: calc(100vh - 190px); overflow: auto; }
    .queue-slidebar.collapsed{ width: var(--qsCollapsed); }
    .queue-slidebar.collapsed .qs-title,
    .queue-slidebar.collapsed .qs-actions,
    .queue-slidebar.collapsed .qs-body{ display:none; }
    .qs-toggle{
      position:absolute; left:-24px; top:50%; transform: translateY(-50%);
      height: 42px; padding: 0 .9rem; border-radius: 9999px;
      display:inline-flex; gap:.45rem; align-items:center; justify-content:center;
      background: radial-gradient(120% 120% at 30% 20%, rgba(99,102,241,.35), rgba(99,102,241,.18)), #0b1220;
      border:1px solid rgba(99,102,241,.55); box-shadow: 0 10px 24px rgba(2,6,23,.45); cursor:pointer;
    }
    .qs-toggle i{ font-size:14px; color:#e5e7eb; }
    .qs-toggle .qs-label{ display:none; font-weight:700; letter-spacing:.3px; }
    .queue-slidebar.collapsed .qs-toggle .qs-label{ display:inline; }

    /* Mobile: keep queue inline (fallback) */
    @media (max-width: 1279px){
      .queue-slidebar{ position: static; width: auto; }
      .qs-toggle{ position: absolute; left: 12px; top: 12px; transform:none; }
    }

    /* ===== Left History Slidebar ===== */
    :root{ --hsW: 320px; }
    .history-slidebar{
      position: fixed; left: 0; top: var(--headerH); width: var(--hsW); z-index: 60;
    }
    .history-slidebar .panel{
      border-top-left-radius: 0; border-bottom-left-radius: 0; border-left:none;
      box-shadow: 12px 0 24px rgba(0,0,0,.35);
    }
    .history-slidebar .hs-header{ display:flex; align-items:center; justify-content:space-between; gap:.5rem; padding:.85rem 1rem; border-bottom:1px solid var(--border); }
    .history-slidebar .hs-body{ padding:.75rem; }
    .history-slidebar .hs-list{ max-height: calc(100vh - 190px); overflow: auto; }
    .history-slidebar.collapsed{ width: 88px; }
    .history-slidebar.collapsed .hs-title,
    .history-slidebar.collapsed .hs-actions,
    .history-slidebar.collapsed .hs-body{ display:none; }
    .hs-toggle{
      position:absolute; right:-21px; top:50%; transform: translateY(-50%);
      width:42px; height:42px; border-radius: 9999px;
      display:inline-flex; align-items:center; justify-content:center;
      background: radial-gradient(120% 120% at 30% 20%, rgba(99,102,241,.35), rgba(99,102,241,.18)), #0b1220;
      border:1px solid rgba(99,102,241,.55); box-shadow: 0 10px 24px rgba(2,6,23,.45); cursor:pointer;
    }
    .hs-toggle i{ font-size:14px; color:#e5e7eb; }

    /* Hide left history on small screens */
    @media (max-width: 1279px){
      .history-slidebar{ display:none; }
    }

    
    .hs-toggle .hs-label{ display:none; font-weight:700; letter-spacing:.3px; margin-left:.5rem; color:#e5e7eb; }
    .history-slidebar.collapsed .hs-toggle .hs-label{ display:inline; }
    
    /* Toast */
    #toast-container{ position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:10px; z-index:9999; }
    .toast{ background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid var(--border); border-radius:12px; padding:.75rem 1rem; min-width:260px; display:flex; align-items:center; gap:.6rem; box-shadow:0 10px 30px rgba(2,6,23,.35); }
    .toast .msg{ flex:1; font-size:.9rem; }
    .toast .undo{ border:1px solid var(--border); padding:.3rem .6rem; border-radius:10px; }
  
    /* Sort caret */
    th.sortable{ cursor:pointer; user-select:none; }
    th.sortable .sort-caret{ display:inline-block; width:0; height:0; margin-left:.35rem; border-left:5px solid transparent; border-right:5px solid transparent; border-top:6px solid var(--muted); transform: translateY(-1px); opacity:.8; }
    th.sortable.desc .sort-caret{ border-top:none; border-bottom:6px solid var(--muted); transform: translateY(2px); }
    th.sortable.active{ color:#e2e8f0; }

  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-white/0">
    <div class="max-w-7xl mx-auto px-5 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-xl bg-white/5 border border-[var(--border)] flex items-center justify-center">
          <i class="fa-solid fa-table-tennis-paddle-ball text-indigo-300"></i>
        </div>
        <h1 class="text-2xl font-bold title-grad">Court Manager</h1>
      </div>
      <div class="flex gap-2">
        <button class="btn btn-ghost" onclick="show('settings-modal')"><i class="fa-solid fa-sliders"></i><span class="hidden sm:inline">กำหนดราคา</span></button>
        <button class="btn btn-ghost" onclick="show('add-player-modal')"><i class="fa-solid fa-user-plus"></i><span class="hidden sm:inline">เพิ่มผู้เล่น</span></button>
        <button class="btn btn-ghost" onclick="show('add-court-modal')"><i class="fa-solid fa-plus"></i><span class="hidden sm:inline">เพิ่มสนาม</span></button>
        <button class="btn" onclick="openDataModal()"><i class="fa-solid fa-database"></i><span class="hidden sm:inline">สำรอง/นำเข้า</span></button>
        <button class="btn" onclick="clearAllCourts()"><i class="fa-solid fa-trash"></i></button>
      </div>
    </div>
    <div class="divider"></div>
  </header>

  <main class="max-w-7xl mx-auto px-5 py-8 space-y-8">
    <!-- Overview -->
    <section class="grid sm:grid-cols-3 gap-4">
      <div class="panel p-5">
        <div class="subtle">ราคาลูกแบด</div>
        <div class="text-2xl font-bold"><span id="shuttlecock-price-display">20</span> บาท</div>
      </div>
      <div class="panel p-5">
        <div class="subtle">ราคาเช่าสนาม</div>
        <div class="text-2xl font-bold"><span id="court-price">0</span> บาท</div>
      </div>
      <div class="panel p-5 flex items-center justify-between">
        <div>
          <div class="subtle">คิวทั้งหมด</div>
          <div class="text-2xl font-bold"><span id="queue-count">0</span> คิว</div>
        </div>
        <div class="flex gap-2">
          <button class="btn btn-green" onclick="buildQueueMatchesFromAvailable()"><i class="fa-solid fa-shuffle"></i><span class="hidden sm:inline">จัดคิวอัตโนมัติ</span></button>
          <button class="btn btn-primary" onclick="openManualMatch()"><i class="fa-solid fa-hand-pointer"></i><span class="hidden sm:inline">จับคู่ด้วยมือ</span></button>
        </div>
      </div>
    </section>

    <!-- Courts -->
    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <div class="heading">สนาม</div>
      </div>
      <div id="court-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
    </section>

    <!-- Players -->
    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <div class="heading">ผู้เล่น</div>
        <div class="flex flex-wrap gap-2">
          <input id="filter-search" class="soft px-3 py-2" placeholder="ค้นหาชื่อ...">
          <select id="filter-skill" class="soft px-3 py-2">
            <option value="">ทุกมือ</option>
            <option>BG</option><option>N</option><option>S</option><option>P-</option><option>P</option><option>P+</option><option>C</option>
          </select>
          <select id="filter-status" class="soft px-3 py-2">
            <option value="">ทุกสถานะ</option>
            <option value="ว่าง">ว่าง</option>
            <option value="ในสนาม">ในสนาม</option>
            <option value="กำลังเล่น">กำลังเล่น</option>
          </select>
          <button class="btn" onclick="selectAllFiltered()"><i class="fa-regular fa-square-check"></i> เลือกทั้งหมด(ตามที่กรอง)</button>
          <button class="btn" onclick="openAssignModal()"><i class="fa-solid fa-arrow-right"></i> เพิ่มผู้เล่นที่เลือกลงสนาม</button>
        </div>
      </div>

      <div class="panel overflow-hidden">
        <table class="table w-full text-sm">
          <thead class="bg-white/5">
            <tr>
              <th class="text-left p-3"><input id="select-all" type="checkbox" class="accent-indigo-400"></th>
              <th class="text-center p-3">#</th>
              <th class="text-left p-3">ชื่อ</th>
              <th class="text-center p-3">มือ</th>
              <th class="text-center p-3">สถานะ</th>
              <th class="text-center p-3 sortable" data-key="games">เกม <span class="sort-caret"></span></th>
              <th class="text-center p-3 sortable" data-key="shuttles">ลูกแบด <span class="sort-caret"></span></th>
              <th class="text-center p-3 sortable" data-key="cost">ค่าใช้จ่าย <span class="sort-caret"></span></th>
              <th class="text-center p-3">จัดการ</th>
            </tr>
          </thead>
          <tbody id="player-table-body"></tbody>
        </table>
      </div>
    </section>
  </main>

  <aside id="history-slidebar" class="history-slidebar">
    <div class="panel relative">
      <button class="hs-toggle" onclick="toggleHistorySidebar()" title="ย่อ/ขยายประวัติ" aria-label="ย่อ/ขยายประวัติ"><i class="fa-solid fa-angles-left"></i><span class="hs-label">ประวัติ</span></button>
      <div class="hs-header">
        <div class="hs-title">ประวัติรวม</div>
        <div class="hs-actions flex gap-2">
          <button class="btn btn-ghost" onclick="clearMatchLog()"><i class="fa-solid fa-eraser"></i> ล้าง</button>
        </div>
      </div>
      <div class="hs-body">
        <div id="history-all-list-side" class="hs-list text-sm"></div>
      </div>
    </div>
  </aside>


  <aside id="queue-slidebar" class="queue-slidebar">
    <div class="panel relative">
      <button class="qs-toggle" onclick="toggleQueueSidebar()" title="ย่อ/ขยายคิว" aria-label="ย่อ/ขยายคิว">
        <i class="fa-solid fa-angles-right"></i><span class="qs-label">คิว</span>
      </button>
      <div class="qs-header">
        <div class="qs-title">คิว (4 คน / 2 คู่)</div>
        <div class="qs-actions flex gap-2">
          <button class="btn" onclick="clearQueueMatches()"><i class="fa-solid fa-broom"></i> ล้างคิว</button>
        </div>
      </div>
      <div class="qs-body">
        <div id="queue-container" class="qs-list space-y-2"></div>
      </div>
    </div>
  </aside>


  <!-- Toast container -->
  <div id="toast-container"></div>

  <!-- Settings / Add Court / Add Player -->
  <div id="settings-modal" class="modal fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-card w-[92vw] max-w-md p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="heading">กำหนดราคา</div>
        <button class="icon-btn" onclick="hide('settings-modal')"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="settings-form" class="grid gap-4">
        <label class="grid gap-2">
          <span class="subtle">ราคาต่อลูกแบด</span>
          <input id="shuttlecock-price" type="number" min="0" class="soft px-3 py-2" placeholder="0" required>
        </label>
        <label class="grid gap-2">
          <span class="subtle">ค่าบริการสนาม (คิดเฉพาะตาแรก)</span>
          <input id="court-rental-fee" type="number" min="0" class="soft px-3 py-2" placeholder="0" required>
        </label>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="hide('settings-modal')">ยกเลิก</button>
          <button type="submit" class="btn btn-primary">บันทึก</button>
        </div>
      </form>
    </div>
  </div>

  <div id="add-court-modal" class="modal fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-card w-[92vw] max-w-md p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="heading">เพิ่มสนาม</div>
        <button class="icon-btn" onclick="hide('add-court-modal')"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="add-court-form" class="grid gap-4">
        <label class="grid gap-2">
          <span class="subtle">ชื่อสนาม</span>
          <input id="court-name-input" class="soft px-3 py-2" placeholder="เช่น สนาม 1" required>
        </label>
        <label class="grid gap-2">
          <span class="subtle">ความจุ (คน)</span>
          <input id="court-capacity-input" type="number" min="1" class="soft px-3 py-2" placeholder="4">
        </label>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="hide('add-court-modal')">ยกเลิก</button>
          <button class="btn btn-green" type="submit">เพิ่มสนาม</button>
        </div>
      </form>
    </div>
  </div>

  <div id="add-player-modal" class="modal fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-card w-[92vw] max-w-md p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="heading">เพิ่มผู้เล่น</div>
        <button class="icon-btn" onclick="hide('add-player-modal')"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="add-player-form" class="grid gap-4">
        <label class="grid gap-2">
          <span class="subtle">ชื่อผู้เล่น</span>
          <input id="player-name-input" class="soft px-3 py-2" placeholder="เช่น นาย A" required>
        </label>
        <label class="grid gap-2">
          <span class="subtle">ประเภทมือ</span>
          <select id="player-skill-input" class="soft px-3 py-2" required>
            <option value="BG">BG</option>
            <option value="N" selected>N</option>
            <option value="S">S</option>
            <option value="P-">P-</option>
            <option value="P">P</option>
            <option value="P+">P+</option>
            <option value="C">C</option>
          </select>
        </label>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" class="btn" onclick="hide('add-player-modal')">ยกเลิก</button>
          <button class="btn btn-primary" type="submit">เพิ่ม</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Manual Queue Modal -->
  <div id="queue-manual-modal" class="modal fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-card w-[94vw] max-w-4xl p-0 overflow-hidden">
      <div class="px-6 py-4 border-b border-[var(--border)] flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="chip"><i class="fa-solid fa-wand-magic-sparkles"></i><span>โหมดเพิ่มคิว</span></div>
          <div class="subtle">เลือกผู้เล่น 4 คน แล้วจัดเป็น 2 คู่</div>
        </div>
        <button class="icon-btn" onclick="hide('queue-manual-modal')"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="grid md:grid-cols-2 gap-0">
        <div class="p-6">
          <div class="heading mb-2">เลือกรายชื่อ</div>
          <div id="manual-list" class="soft p-3 max-h-[60vh] overflow-auto"></div>
        </div>
        <div class="p-6 border-l border-[var(--border)]">
          <div class="heading mb-2">สลอต 1–4</div>
          <div id="manual-slots" class="grid grid-cols-2 gap-2 mb-4"></div>
          <div class="heading mb-2">พรีวิว</div>
          <div id="manual-stage" class="soft p-4 min-h-[120px] mb-3"></div>
          <div class="flex flex-wrap gap-2">
            <button id="btn-pair-default" class="btn btn-green disabled:opacity-40" disabled>1-2 vs 3-4</button>
            <button id="btn-pair-acbd" class="btn disabled:opacity-40" disabled>1-3 / 2-4</button>
            <button id="btn-pair_adbc" class="btn disabled:opacity-40" disabled>1-4 / 2-3</button>
            <button id="btn-add-match" class="btn btn-primary ml-auto disabled:opacity-40" disabled>เพิ่มลงคิว</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Modal -->
  <div id="manage-modal" class="modal fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-card w-[94vw] max-w-3xl p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="heading">จัดการผู้เล่นใน <span id="manage-court-name"></span></div>
        <button class="icon-btn" onclick="hide('manage-modal')"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="soft p-3 mb-4">
        <p class="subtle mb-3">แตะสลอต 2 จุดเพื่อ <span class="font-semibold">สลับตำแหน่ง</span> • บันทึกอัตโนมัติ</p>
        <div class="grid md:grid-cols-2 gap-3">
          <div class="pair-box">
            <div class="pair-title mb-2">คู่ A</div>
            <div class="space-y-2">
              <div class="slot" id="pairA-0"></div>
              <div class="slot" id="pairA-1"></div>
            </div>
          </div>
          <div class="pair-box">
            <div class="pair-title mb-2">คู่ B</div>
            <div class="space-y-2">
              <div class="slot" id="pairB-0"></div>
              <div class="slot" id="pairB-1"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="soft p-3">
        <div class="flex items-center justify-between">
          \1
          <div class="flex items-center gap-2">
            <select id="bulk-move-select" class="soft px-2 py-1 text-sm"></select>
            <button id="bulk-move-btn" class="btn"><i class="fa-solid fa-people-arrows"></i> ย้ายทั้งหมด</button>
          </div>
          <button class="btn btn-green" onclick="openFreePicker(null, _manageCtx?.courtId)"><i class="fa-solid fa-user-plus"></i> เพิ่มผู้เล่นว่างเข้าสนาม</button>
        </div>
        <div id="manage-list" class="space-y-2 mt-3 max-h-[45vh] overflow-auto"></div>
      </div>
    </div>
  </div>

  <!-- Free picker -->
  <div id="free-picker-modal" class="modal fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-card w-[92vw] max-w-md p-6">
      <div class="flex items-center justify-between mb-3">
        <div class="heading">เลือกผู้เล่นที่ว่างอยู่</div>
        <button class="icon-btn" onclick="hide('free-picker-modal')"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <input id="free-search" class="soft w-full px-3 py-2 mb-3" placeholder="ค้นหาชื่อ...">
      <div id="free-list" class="soft p-3 max-h-[55vh] overflow-auto text-sm"></div>
    </div>
  </div>

  <!-- History -->
  <div id="history-modal" class="modal fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-card w-[92vw] max-w-lg p-6">
      <div class="flex items-center justify-between mb-3">
        <div class="heading">ประวัติการจับคู่ของ <span id="history-player-name"></span></div>
        <button class="icon-btn" onclick="hide('history-modal')"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="history-list" class="soft p-3 max-h-[60vh] overflow-auto"></div>
    </div>
  </div>

  <!-- Assign / Shuttle / Queue send -->
  <div id="assign-modal" class="modal fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-card w-[94vw] max-w-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="heading">เลือกสนามสำหรับผู้เล่นที่เลือก</div>
        <button class="icon-btn" onclick="hide('assign-modal')"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="assign-court-list" class="soft p-3 max-h-[50vh] overflow-auto"></div>
      <div class="flex items-center justify-between mt-3">
        <label class="flex items-center gap-2 subtle">
          <input id="assign-auto" type="checkbox" class="accent-indigo-400"> กระจายไปสนามที่ว่าง
        </label>
        <div class="flex gap-2">
          <button class="btn" onclick="hide('assign-modal')">ยกเลิก</button>
          <button class="btn btn-green" onclick="confirmAssign()">ยืนยัน</button>
        </div>
      </div>
    </div>
  </div>

  <div id="confirm-shuttle-modal" class="modal fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-card w-[92vw] max-w-md p-6">
      <div class="flex items-center justify-between mb-3">
        <div class="heading">ยืนยันการเพิ่มลูกแบด</div>
        <button class="icon-btn" onclick="hide('confirm-shuttle-modal')"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="soft p-3 mb-3">
        เพิ่มให้ <span id="confirm-shuttlecourt-name" class="font-semibold"></span><br/>
        ผู้เล่น: <span id="confirm-shuttlecourt-players" class="muted">—</span>
      </div>
      <div class="flex justify-end gap-2">
        <button class="btn" onclick="hide('confirm-shuttle-modal')">ยกเลิก</button>
        <button class="btn btn-primary" onclick="confirmAddShuttlecock()">ยืนยัน</button>
      </div>
    </div>
  </div>

  <div id="queue-send-modal" class="modal fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-card w-[92vw] max-w-md p-6">
      <div class="flex items-center justify-between mb-3">
        <div class="heading">ส่งคิวลงสนาม</div>
        <button class="icon-btn" onclick="hide('queue-send-modal')"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="queue-send-summary" class="soft p-3 mb-3 text-sm"></div>
      <div id="queue-send-court" class="soft p-3 mb-3"></div>
      <div class="flex justify-end gap-2">
        <button class="btn" onclick="hide('queue-send-modal')">ยกเลิก</button>
        <button class="btn btn-green" onclick="confirmSendQueueMatch()">ยืนยัน</button>
      </div>
    </div>
  </div>

  <!-- Data modal -->
  <div id="data-modal" class="modal fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-card w-[92vw] max-w-lg p-6">
      <div class="flex items-center justify-between mb-3">
        <div class="heading">สำรอง/นำเข้าข้อมูล</div>
        <button class="icon-btn" onclick="hide('data-modal')"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="grid gap-3">
        <button class="btn btn-green" onclick="exportData()"><i class="fa-solid fa-file-arrow-down"></i> ดาวน์โหลดไฟล์สำรอง (JSON)</button>
        <label class="btn">
          <i class="fa-solid fa-file-arrow-up"></i> เลือกไฟล์นำเข้า (JSON)
          <input id="import-file" type="file" accept="application/json" class="hidden" onchange="importDataFile(this.files[0])" />
        </label>
        <textarea id="export-textarea" class="soft p-3 text-xs min-h-[140px]" placeholder="ข้อมูล JSON จะปรากฏที่นี่เมื่อต้องการคัดลอกด้วยมือ"></textarea>
      </div>
    </div>
  </div>

  <script>
    /* ------- Utilities / Storage ------- */
    const uuid=()=> (crypto?.randomUUID?crypto.randomUUID():'id-'+Math.random().toString(36).slice(2)+Date.now());
    const show=id=>{const el=document.getElementById(id); if(el){el.classList.remove('hidden'); el.classList.add('flex');}};
    const hide=id=>{const el=document.getElementById(id); if(el){el.classList.add('hidden'); el.classList.remove('flex');}};
    const getNumberOrZero=v=>{const n=parseFloat(v);return Number.isFinite(n)?n:0;};
    const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    const load=(k,def)=>{try{return JSON.parse(localStorage.getItem(k)??JSON.stringify(def))}catch{return def}};
    const savePlayers=v=>save('players',v), getPlayers=()=>load('players',[]);
    const saveCourts =v=>save('courts',v),  getCourts =()=>load('courts',[]);
    const saveQueue  =v=>save('queue_matches',v), getQueue=()=>load('queue_matches',{matches:[]});
    const mapById = arr => { const m=new Map(); arr.forEach(x=>m.set(x.id,x)); return m; };
    const minutesSince=ts=>!ts?0:(Math.floor((Date.now()-ts)/60000)||'<1');

    /* ------- Toast + Undo ------- */
    let _undo = null; // {do:fn, undo:fn, label:string}
    function showToast(msg, undoLabel=null, undoHandler=null, timeoutMs=6000){
      const cont=document.getElementById('toast-container');
      const el=document.createElement('div'); el.className='toast';
      el.innerHTML=`<div class="msg">${msg}</div>${undoLabel?`<button class="undo">${undoLabel}</button>`:''}<button class="icon-btn" title="ปิด"><i class="fa-solid fa-xmark"></i></button>`;
      cont.appendChild(el);
      const closeBtn=el.querySelector('.icon-btn'); const undoBtn=el.querySelector('.undo');
      const close=()=>{ if(el.parentNode) el.parentNode.removeChild(el); };
      closeBtn.onclick=close;
      if(undoLabel && undoHandler){ undoBtn.onclick=()=>{ try{ undoHandler(); } finally { close(); } }; }
      const t=setTimeout(close, timeoutMs);
    }
    function setUndo(label, undoFn){ _undo = {label, undoFn}; }
    function triggerUndo(){ if(_undo?.undoFn){ _undo.undoFn(); _undo=null; } }

    /* ------- Price ------- */
    function getPrice(){return {shuttle:parseFloat(localStorage.getItem('shuttlecockPrice')??'20'), fee:parseFloat(localStorage.getItem('courtRentalFee')??'0')}};
    function updatePriceDisplay(){const p=getPrice(); document.getElementById('shuttlecock-price-display').textContent=p.shuttle; document.getElementById('court-price').textContent=p.fee;}

    document.getElementById('settings-form').addEventListener('submit',e=>{
      e.preventDefault();
      localStorage.setItem('shuttlecockPrice', document.getElementById('shuttlecock-price').value);
      localStorage.setItem('courtRentalFee',  document.getElementById('court-rental-fee').value);
      hide('settings-modal'); updatePriceDisplay(); renderPlayers();
      showToast('บันทึกราคาเรียบร้อย ✓');
    });

    /* ------- Data migration ------- */
    function migrate(){
      let players=getPlayers(); let changed=false;
      for(const p of players){
        if(!p.id){ p.id=uuid(); changed=true; }
        if(!p.status){ p.status='ว่าง'; changed=true; }
        if(!p.skill){ p.skill='N'; changed=true; }
        if(!Array.isArray(p.history)){ p.history=[]; changed=true; }
      }
      if(changed) savePlayers(players);

      let courts=getCourts();
      for(const c of courts){
        if(!c.id){ c.id=uuid(); }
        if(!c.players) c.players=[];
        if(!Array.isArray(c.pairs)) c.pairs=[];
        if(c.waiting===undefined) c.waiting=null;
        if(typeof c.roundNo!=='number') c.roundNo=0;
        ensurePairs(c); recalcCourtStatus(c);
      }
      saveCourts(courts);
    }

    
    /* ===== Slidebars + History (safe hooks) ===== */
    // Persist collapsed state
    function applyQueueSidebarState(){
      const el = document.getElementById('queue-slidebar'); if(!el) return;
      const collapsed = localStorage.getItem('queueSidebarCollapsed') === '1';
      el.classList.toggle('collapsed', collapsed);
      updateQueueBadge();
    }
    function toggleQueueSidebar(){
      const el = document.getElementById('queue-slidebar'); if(!el) return;
      const collapsed = el.classList.contains('collapsed');
      el.classList.toggle('collapsed', !collapsed);
      localStorage.setItem('queueSidebarCollapsed', (!collapsed)?'1':'0');
      updateQueueBadge();
    }
    function updateQueueBadge(){
      const el = document.querySelector('#queue-slidebar .qs-label');
      if(!el) return;
      const n = (getQueue()?.matches?.length)||0;
      el.textContent = `คิว (${n})`;
    }

    function applyHistorySidebarState(){
      const el = document.getElementById('history-slidebar'); if(!el) return;
      const collapsed = localStorage.getItem('historySidebarCollapsed') === '1';
      el.classList.toggle('collapsed', collapsed);
    }
    function toggleHistorySidebar(){
      const el = document.getElementById('history-slidebar'); if(!el) return;
      const collapsed = el.classList.contains('collapsed');
      el.classList.toggle('collapsed', !collapsed);
      localStorage.setItem('historySidebarCollapsed', (!collapsed)?'1':'0');
    }

    // Global match log helpers
    const saveMatchLog = v => save('match_log', v);
    const getMatchLog  = () => load('match_log', []);

    // Append with dedupe (use signature + 4s window) and global seq
    function appendMatchLog(court){
      if(!court) return;
      const ev = { ts: Date.now(), courtId: court.id, courtName: court.name, round: court.roundNo||0, pairs: (court.pairs||[]).map(pr=>[...pr]) };
      const makeSig = (e)=>{
        try{ return `${e.courtId||''}|${(e.pairs||[]).flat().filter(Boolean).map(String).sort().join(',')}`; }catch(_){ return `${e.courtId||''}|?`; }
      };
      ev._sig = makeSig(ev);

      const log = getMatchLog();
      const last = log.length ? log[log.length-1] : null;
      const lastSig = last ? (last._sig || makeSig(last)) : null;
      const recent = last && (Math.abs((ev.ts)-(last.ts||0)) <= 4000);
      const sameSig = last && (lastSig === ev._sig);
      if(recent && sameSig){ return; } // skip duplicate

      const lastSeq = (log.length>0 && typeof (last && last.seq)==='number') ? last.seq : log.length;
      ev.seq = lastSeq + 1;
      log.push(ev); saveMatchLog(log);
      try{ renderAllHistorySidebar(); }catch(e){}
    }

    function renderAllHistorySidebar(){
      const host = document.getElementById('history-all-list-side'); if(!host) return;
      host.innerHTML='';
      const players=getPlayers(), byId=mapById(players);
      const raw = getMatchLog().slice();
      if(raw.length===0){ host.innerHTML='<div class="muted">ยังไม่มีประวัติ</div>'; return; }
      const log = raw.slice().sort((a,b)=>(b.ts||0)-(a.ts||0));
      const fmt=ts=>{const d=new Date(ts),pad=n=>String(n).padStart(2,'0');return `${pad(d.getHours())}:${pad(d.getMinutes())} • ${pad(d.getDate())}/${d.getMonth()+1}/${d.getFullYear()}`};
      log.forEach(ev=>{
        const pairs = ev.pairs||[[],[]];
        const [A,B,C,D] = [pairs?.[0]?.[0], pairs?.[0]?.[1], pairs?.[1]?.[0], pairs?.[1]?.[1]];
        const n=id=>byId.get(id)?.name||'—', s=id=>byId.get(id)?.skill||'N';
        const row=document.createElement('div'); row.className='border-b border-[var(--border)] py-2';
        row.innerHTML = `<div class="font-semibold">ลำดับ ${ev.seq||'?'} • ${ev.courtName||'—'}</div>
            <div class="muted">
              <span class="chip">${n(A)} <span class="tag">มือ ${s(A)}</span></span>
              <span class="muted">×</span>
              <span class="chip">${n(B)} <span class="tag">มือ ${s(B)}</span></span>
              <span class="muted">เจอ</span>
              <span class="chip">${n(C)} <span class="tag">มือ ${s(C)}</span></span>
              <span class="muted">×</span>
              <span class="chip">${n(D)} <span class="tag">มือ ${s(D)}</span></span>
            </div>
            <div class="muted text-xs">${fmt(ev.ts)}</div>`;
        host.appendChild(row);
      });
    }

    // Safe hook into pushHistory (called when startGame runs) — do not change original logic
    try{
      const _pushHistory_orig = pushHistory;
      pushHistory = function(court, players){
        _pushHistory_orig(court, players);
        try{ appendMatchLog(court); }catch(e){}
      };
    }catch(e){ /* if not found, ignore */ }


    
    function clearMatchLog(){ try{ save('match_log', []); renderAllHistorySidebar?.(); showToast('ล้างประวัติรวมแล้ว ✓'); }catch(e){ alert('ล้างประวัติไม่สำเร็จ: '+e.message);} }
    /* ------- Helpers ------- */
    function ensureAvailableSince(players){
      const now=Date.now();
      players.forEach(p=>{
        if(p.status==='ว่าง'&&!p.availableSince) p.availableSince=now;
        if(p.status!=='ว่าง'&&p.availableSince)  p.availableSince=null;
      }); return players;
    }
    function recalcCourtStatus(c){ if(!c.players||c.players.length===0) c.status='ว่าง'; else if(c.status!=='กำลังเล่น') c.status='พร้อมเล่น'; }
    function ensurePairs(c){
      if(!c.players) c.players=[]; if(!Array.isArray(c.pairs)) c.pairs=[];
      const set=new Set(c.players), used=new Set(), cleaned=[];
      c.pairs.forEach(pr=>{ if(Array.isArray(pr)&&pr.length===2 && set.has(pr[0])&&set.has(pr[1]) && !used.has(pr[0])&&!used.has(pr[1])){ cleaned.push([pr[0],pr[1]]); used.add(pr[0]); used.add(pr[1]); } });
      if(cleaned.length<2 && c.players.length>=4){
        const ids=c.players.slice(0,4);
        cleaned.length=0; cleaned.push([ids[0],ids[1]],[ids[2],ids[3]]);
      }
      c.pairs=cleaned;
      const usedIds=new Set(c.pairs.flat()); const remain=c.players.filter(id=>!usedIds.has(id)); c.waiting=remain[0]||null;
      return c;
    }

    /* ------- History ------- */
    const opponentIndex = idx => (idx%2===0)? idx+1 : idx-1;
    function pushHistory(court, players){
      const byId=mapById(players), ts=Date.now();
      court.roundNo=(court.roundNo||0)+1;
      (court.pairs||[]).forEach((pr,idx)=>{
        const opp=(court.pairs||[])[opponentIndex(idx)]||[];
        pr.forEach((pid,k)=>{
          const p=byId.get(pid); if(!p) return;
          const partnerId=pr[1-k];
          p.history.push({ts, courtId: court.id, courtName: court.name, round: court.roundNo, partnerId, opponentsIds: opp.filter(x=>x!==pid&&x!==partnerId)});
        });
      });
    }
    function openHistory(id){
      const players=getPlayers(), p=players.find(x=>x.id===id); if(!p) return;
      document.getElementById('history-player-name').textContent=p.name||'—';
      const host=document.getElementById('history-list'); host.innerHTML='';
      const byId=mapById(players);
      const fmt=ts=>{const d=new Date(ts),pad=n=>String(n).padStart(2,'0');return `${pad(d.getHours())}:${pad(d.getMinutes())} • ${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`};
      const hist=[...(p.history||[])].sort((a,b)=>(b.ts||0)-(a.ts||0));
      if(hist.length===0){ host.innerHTML='<div class="muted">ยังไม่มีประวัติ</div>'; show('history-modal'); return; }
      hist.forEach(h=>{
        const partner=byId.get(h.partnerId)?.name||'—';
        const opp=(h.opponentsIds||[]).map(x=>byId.get(x)?.name||'—').join(', ')||'—';
        const row=document.createElement('div'); row.className='flex items-center justify-between border-b border-[var(--border)] py-2';
        row.innerHTML=`<div><div class="font-semibold">ตา ${h.round} • ${h.courtName||'—'}</div><div class="muted text-xs">คู่กับ ${partner} • คู่แข่ง ${opp}</div></div><div class="muted text-xs">${fmt(h.ts)}</div>`;
        host.appendChild(row);
      });
      show('history-modal');
    }
    window.openHistory=openHistory;

    /* ------- Filters ------- */
    let _filter = {q:'', skill:'', status:''};
    const filterSearch=document.getElementById('filter-search');
    const filterSkill=document.getElementById('filter-skill');
    const filterStatus=document.getElementById('filter-status');
    filterSearch.oninput=(e)=>{ _filter.q = e.target.value.trim().toLowerCase(); renderPlayers(); };
    filterSkill.onchange=(e)=>{ _filter.skill = e.target.value; renderPlayers(); };
    filterStatus.onchange=(e)=>{ _filter.status = e.target.value; renderPlayers(); };

    function passFilter(p){
      if(_filter.q && !(p.name||'').toLowerCase().includes(_filter.q)) return false;
      if(_filter.skill && p.skill!==_filter.skill) return false;
      if(_filter.status && p.status!==_filter.status) return false;
      return true;
    }

    
    /* Sorting headers setup */
    let _sort = {key:null, dir:1};
    function setupSortableHeaders(){
      const map = {'เกม':'games','ลูกแบด':'shuttles','ค่าใช้จ่าย':'cost'};
      const ths = document.querySelectorAll('thead th');
      ths.forEach(th=>{
        const label = (th.textContent||'').trim();
        if(map[label]){
          th.classList.add('sortable');
          th.setAttribute('data-key', map[label]);
          if(!th.querySelector('.sort-caret')){
            const span=document.createElement('span'); span.className='sort-caret'; th.appendChild(span);
          }
        }
      });
      const thead=document.querySelector('thead');
      if(!thead.__sortBound){
        thead.addEventListener('click', e=>{
          const th = e.target.closest('th.sortable'); if(!th) return;
          const key = th.getAttribute('data-key');
          if(_sort.key===key){ _sort.dir = -_sort.dir; } else { _sort.key = key; _sort.dir = 1; }
          localStorage.setItem('playerSort', JSON.stringify(_sort));
          renderPlayers();
        });
        thead.__sortBound = true;
      }
      try{ const s=JSON.parse(localStorage.getItem('playerSort')||'null'); if(s) _sort=s; }catch{}
      applySortHeaders();
    }
    function applySortHeaders(){
      const ths = document.querySelectorAll('thead th.sortable');
      ths.forEach(th=>{
        th.classList.remove('active','desc');
        const key=th.getAttribute('data-key');
        if(key===_sort.key){
          th.classList.add('active');
          if(_sort.dir===-1) th.classList.add('desc');
        }
      });
    }

    
    /* Sort handlers */
    function attachSortHandlers(){
      const thead = document.querySelector('thead');
      if(!thead) return;
      thead.addEventListener('click', (e)=>{
        const th = e.target.closest('th.sortable'); if(!th) return;
        const key = th.getAttribute('data-key');
        if(!window._sort) window._sort = {key:null, dir:1};
        if(_sort.key===key){ _sort.dir = -_sort.dir; } else { _sort.key = key; _sort.dir = 1; }
        try{ localStorage.setItem('playerSort', JSON.stringify(_sort)); }catch{}
        renderPlayers();
      });
    }
    function applySortHeaders(){
      const ths = document.querySelectorAll('thead th.sortable');
      ths.forEach(th=>{
        th.classList.remove('active','desc');
        const key = th.getAttribute('data-key');
        if(window._sort && key===_sort.key){
          th.classList.add('active');
          if(_sort.dir===-1) th.classList.add('desc');
        }
      });
    }
    (function restoreSort(){
      try{ const s = JSON.parse(localStorage.getItem('playerSort')||'null'); if(s) window._sort=s; }catch{ window._sort={key:null, dir:1}; }
    })();
    
    /* ------- Players render ------- */
    let _editPlayerId=null; let _editingForm=false;
    function renderPlayers(){
      const tbody=document.getElementById('player-table-body'); tbody.innerHTML='';
      const players=ensureAvailableSince(getPlayers()); savePlayers(players);
      const {shuttle,fee}=getPrice();

      const data = players.filter(passFilter);
      // ---- robust sort block ----
      if(!_sort){ window._sort = {key:null, dir:1}; }
      const getVal = (p)=>{
        if(_sort.key==='games') return p.gamesPlayed||0;
        if(_sort.key==='shuttles') return p.shuttlecocksUsed||0;
        if(_sort.key==='cost'){ const {shuttle, fee}=getPrice(); const feeOnce=(p.gamesPlayed||0)>0?fee:0; return (p.shuttlecocksUsed||0)*shuttle + feeOnce; }
        return 0;
      };
      if(_sort.key){
        data.sort((a,b)=>{
          const va=getVal(a), vb=getVal(b);
          if(va===vb) return (a.name||'').localeCompare(b.name||'');
          return (va<vb? -1:1) * (_sort.dir||1);
        });
      } else {
        data.sort((a,b)=>{
          const order=s=>s==='ว่าง'?0:(s==='ในสนาม'?1:2);
          const oa=order(a.status), ob=order(b.status);
          if(oa!==ob) return oa-ob;
          if(a.status==='ว่าง'&&b.status==='ว่าง') return (a.availableSince??Date.now())-(b.availableSince??Date.now());
          return (a.name||'').localeCompare(b.name||'');
        });
      }
      // update header states
      if(typeof applySortHeaders==='function') applySortHeaders();
        

      // Apply sort if set
      if(window._sort && _sort.key){
        const getVal = (p)=>{
          if(_sort.key==='games') return p.gamesPlayed||0;
          if(_sort.key==='shuttles') return p.shuttlecocksUsed||0;
          if(_sort.key==='cost'){
            const feeOnce = (p.gamesPlayed||0)>0? fee:0;
            return (p.shuttlecocksUsed||0)*shuttle + feeOnce;
          }
          return 0;
        };
        data.sort((a,b)=>{
          const va=getVal(a), vb=getVal(b);
          if(va===vb) return (a.name||'').localeCompare(b.name||'');
          return (_sort.dir||1) * (va - vb);
        });
      }else{
        data.sort((a,b)=>{
          const order=s=>s==='ว่าง'?0:(s==='ในสนาม'?1:2);
          const oa=order(a.status), ob=order(b.status);
          if(oa!==ob) return oa-ob;
          if(a.status==='ว่าง'&&b.status==='ว่าง') return (a.availableSince??Date.now())-(b.availableSince??Date.now());
          return (a.name||'').localeCompare(b.name||'');
        });
      }

      data.forEach((p,i)=>{
        const feeOnce = (p.gamesPlayed||0) > 0 ? fee : 0;
        const cost=(p.shuttlecocksUsed||0)*shuttle + feeOnce;
        const cls=p.status==='ว่าง'?'available':(p.status==='ในสนาม'?'ready':'playing');
        const info = p.status==='ว่าง'?`<span class="badge">รอ ${minutesSince(p.availableSince)} นาที</span>`:(p.status==='ในสนาม'?`<span class="badge">รอเริ่ม</span>`:'');
        tbody.insertAdjacentHTML('beforeend',`
          <tr>
            <td class="p-3"><input type="checkbox" class="player-checkbox accent-indigo-400" data-player-id="${p.id}"></td>
            <td class="p-3 text-center">${i+1}</td>
            <td class="p-3"><button class="text-indigo-300 hover:underline" onclick="openHistory('${p.id}')">${p.name}</button></td>
            <td class="p-3 text-center"><span class="badge">มือ ${p.skill||'N'}</span></td>
            <td class="p-3 text-center"><span class="status ${cls}">${p.status}</span> ${info}</td>
            <td class="p-3 text-center">${p.gamesPlayed||0}</td>
            <td class="p-3 text-center">${p.shuttlecocksUsed||0}</td>
            <td class="p-3 text-center">${cost}</td>
            <td class="p-3 text-center">
              <button class="icon-btn" title="แก้ไข" onclick="openEditPlayer('${p.id}','${encodeURIComponent(p.name)}')"><i class="fa-solid fa-pen"></i></button>
              <button class="icon-btn" title="ลบ" onclick="deletePlayer('${p.id}')"><i class="fa-solid fa-trash"></i></button>
            </td>
          </tr>`);
      });

      const master=document.getElementById('select-all'); master.checked=false;
      master.onchange=e=>{
        const check = e.target.checked;
        document.querySelectorAll('#player-table-body .player-checkbox').forEach(cb=>cb.checked=check);
      };

      document.getElementById('queue-count').textContent = getQueue().matches?.length || 0;
      if(typeof applySortHeaders==='function') applySortHeaders();
}

    function selectAllFiltered(){
      document.querySelectorAll('#player-table-body .player-checkbox').forEach(cb=>cb.checked=true);
      showToast('เลือกผู้เล่นตามการกรองแล้ว ✓');
    }

    function openEditPlayer(id, safeName){
      _editPlayerId=id;
      const players=getPlayers(); const p=players.find(x=>x.id===id);
      show('add-player-modal');
      document.querySelector('#add-player-modal .heading').innerHTML='แก้ไขผู้เล่น';
      document.getElementById('player-name-input').value=decodeURIComponent(safeName||'');
      document.getElementById('player-skill-input').value=p?.skill||'N';
      const submitBtn = document.querySelector('#add-player-form button[type="submit"]');
      submitBtn.textContent = 'บันทึก';
      submitBtn.classList.remove('btn-primary'); submitBtn.classList.add('btn-green');
      _editingForm = true;
    }
    document.getElementById('add-player-form').addEventListener('submit',e=>{
      e.preventDefault();
      const name=document.getElementById('player-name-input').value.trim();
      const skill=document.getElementById('player-skill-input').value||'N';
      let players=getPlayers();
      if(_editingForm){
        const p=players.find(x=>x.id===_editPlayerId);
        if(p){ p.name=name; p.skill=skill; savePlayers(players); _editingForm=false; hide('add-player-modal'); renderPlayers(); renderCourts(); showToast('บันทึกผู้เล่นแล้ว ✓'); return; }
      }
      players.push({id:uuid(), name, skill, status:'ว่าง', gamesPlayed:0, shuttlecocksUsed:0, availableSince:Date.now(), history:[]});
      savePlayers(players); hide('add-player-modal'); renderPlayers(); renderQueue(); showToast('เพิ่มผู้เล่นแล้ว ✓');
      document.querySelector('#add-player-modal .heading').innerHTML='เพิ่มผู้เล่น';
      const submitBtn = document.querySelector('#add-player-form button[type="submit"]');
      submitBtn.textContent = 'เพิ่ม'; submitBtn.classList.remove('btn-green'); submitBtn.classList.add('btn-primary');
      e.target.reset();
    });
    function deletePlayer(id){
      if(!confirm('ลบผู้เล่นนี้ออกจากระบบ?')) return;
      let players=getPlayers(); const courts=getCourts();
      const before = {players: JSON.parse(JSON.stringify(players)), courts: JSON.parse(JSON.stringify(courts)), queue: getQueue()};
      for(const c of courts){
        c.players=(c.players||[]).filter(pid=>pid!==id);
        if(Array.isArray(c.pairs)) c.pairs=c.pairs.filter(pr=>!pr.includes(id));
        if(c.waiting===id) c.waiting=null; ensurePairs(c); recalcCourtStatus(c);
      }
      saveCourts(courts);
      const q=getQueue(); q.matches=(q.matches||[]).filter(mt=> !mt.pairs.some(pr=>pr.includes(id))); saveQueue(q);
      players=players.filter(x=>x.id!==id); savePlayers(players);
      renderPlayers(); renderCourts(); renderQueue();
      setUndo('ลบผู้เล่น', ()=>{ savePlayers(before.players); saveCourts(before.courts); saveQueue(before.queue); renderPlayers(); renderCourts(); renderQueue(); });
      showToast('ลบผู้เล่นแล้ว', 'เลิกทำ', triggerUndo);
    }

    /* ------- Courts ------- */
    function renderCourts(){
      const wrap=document.getElementById('court-container'); wrap.innerHTML='';
      const courts=getCourts(), players=getPlayers(), byId=mapById(players);
      courts.forEach(c=>{
        ensurePairs(c);
        const cap=c.capacity??4, used=(c.players||[]).length, percent=Math.min(100,(used/cap)*100);
        const fmtPair = pr => `${byId.get(pr?.[0])?.name||'—'} × ${byId.get(pr?.[1])?.name||'—'}`;
        let label='ไม่มีผู้เล่น';
        if ((c.pairs?.length||0) >= 2) label = `${fmtPair(c.pairs[0])} <span class="muted">เจอ</span> ${fmtPair(c.pairs[1])}`;
        else if ((c.pairs?.length||0) === 1) label = fmtPair(c.pairs[0]);
        const cls=c.status==='กำลังเล่น'?'playing':(used===0?'available':'ready');
        const startDis=(c.status==='กำลังเล่น'||used===0|| (c.pairs?.length||0) < 2)?'opacity-40 pointer-events-none':'';
        const endDis  =(c.status!=='กำลังเล่น')?'opacity-40 pointer-events-none':'';
        const card=document.createElement('div'); card.className='panel p-5';
        card.innerHTML=`
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <div class="badge">สนาม</div>
              <div class="text-lg font-semibold">${c.name}</div>
            </div>
            <span class="status ${cls}">${ used===0 ? 'ว่าง' : (c.status==='กำลังเล่น'?'กำลังเล่น':'พร้อมเล่น') }</span>
          </div>
          <div class="muted text-xs mb-2">ตาปัจจุบัน: ${c.roundNo||0}</div>
          <div class="mb-3 text-sm"><span class="muted">ผู้เล่น (${used}/${cap})</span><div class="mt-1 font-medium">${label}</div></div>
          <div class="w-full bg-white/5 rounded-full h-1.5 mb-4"><div class="bg-indigo-400 h-1.5 rounded-full" style="width:${percent}%"></div></div>
          <div class="flex flex-wrap gap-2">
            <button class="btn btn-green ${startDis}" onclick="startGame('${c.id}')"><i class="fa-solid fa-play"></i> เริ่มเกม</button>
            <button class="btn ${endDis}" onclick="endGame('${c.id}')"><i class="fa-solid fa-stop"></i> จบเกม</button>
            <button class="btn" onclick="openManage('${c.id}')"><i class="fa-solid fa-sliders"></i> จัดการ</button>
            <button class="btn" onclick="openConfirmShuttlecock('${c.id}')"><i class="fa-solid fa-plus"></i> เพิ่มลูก</button>
          </div>`;
        wrap.appendChild(card);
      });
    }

    function startGame(courtId){
      const courts=getCourts(), players=getPlayers(), byId=mapById(players);
      const c=courts.find(x=>x.id===courtId); if(!c) return; ensurePairs(c);
      if(!c.players||c.players.length===0){ alert('ยังไม่มีผู้เล่นในสนาม'); return; }
      if((c.pairs?.length||0) < 2){ alert('โปรดตั้งคู่ให้ครบ 2 คู่ก่อนเริ่ม'); return; }
      if(c.status==='กำลังเล่น') return;
      const beforePlayers=JSON.parse(JSON.stringify(players));
      const beforeCourts=JSON.parse(JSON.stringify(courts));
      pushHistory(c, players);
      c.players.forEach(pid=>{ const p=byId.get(pid); if(p){ p.status='กำลังเล่น'; p.availableSince=null; p.gamesPlayed=(p.gamesPlayed||0)+1; p.shuttlecocksUsed=(p.shuttlecocksUsed||0)+1; } });
      c.status='กำลังเล่น'; savePlayers(players); saveCourts(courts); renderPlayers(); renderCourts();
      setUndo('เริ่มเกม', ()=>{ savePlayers(beforePlayers); saveCourts(beforeCourts); renderPlayers(); renderCourts(); });
      showToast('เริ่มเกมแล้ว ✓','เลิกทำ', triggerUndo);
    }
    function endGame(courtId){
      const courts=getCourts(), players=getPlayers(), byId=mapById(players);
      const c=courts.find(x=>x.id===courtId); if(!c) return;
      const beforePlayers=JSON.parse(JSON.stringify(players));
      const beforeCourts=JSON.parse(JSON.stringify(courts));
      (c.players||[]).forEach(pid=>{ const p=byId.get(pid); if(p){ p.status='ว่าง'; p.availableSince=Date.now(); }});
      c.players=[]; c.pairs=[]; c.waiting=null; c.status='ว่าง';
      savePlayers(players); saveCourts(courts); renderPlayers(); renderCourts();
      setUndo('จบเกม', ()=>{ savePlayers(beforePlayers); saveCourts(beforeCourts); renderPlayers(); renderCourts(); });
      showToast('จบเกมแล้ว ✓','เลิกทำ', triggerUndo);
    }
    function openConfirmShuttlecock(courtId){
      const courts=getCourts(), players=getPlayers(), byId=mapById(players);
      const c=courts.find(x=>x.id===courtId); if(!c) return;
      document.getElementById('confirm-shuttlecourt-name').textContent=c.name||'—';
      const names=(c.players||[]).map(pid=>byId.get(pid)?.name).filter(Boolean).join(', ')||'—';
      document.getElementById('confirm-shuttlecourt-players').textContent=names; show('confirm-shuttle-modal');
      window._shuttleCourtId=courtId;
    }
    function confirmAddShuttlecock(){
      const courtId=window._shuttleCourtId; if(!courtId) return;
      const courts=getCourts(), players=getPlayers(), byId=mapById(players);
      const c=courts.find(x=>x.id===courtId); if(!c) return;
      const before=JSON.parse(JSON.stringify(players));
      (c.players||[]).forEach(pid=>{ const p=byId.get(pid); if(p) p.shuttlecocksUsed=(p.shuttlecocksUsed||0)+1; });
      savePlayers(players); renderPlayers(); hide('confirm-shuttle-modal');
      setUndo('เพิ่มลูกแบด', ()=>{ savePlayers(before); renderPlayers(); });
      showToast('เพิ่มลูกแบดแล้ว ✓','เลิกทำ', triggerUndo);
    }

    /* ------- Assign to court ------- */
    let _assignIds=[];
    function openAssignModal(){
      _assignIds = Array.from(document.querySelectorAll('#player-table-body .player-checkbox:checked')).map(cb=>cb.getAttribute('data-player-id')).filter(Boolean);
      if(_assignIds.length===0){ alert('กรุณาเลือกผู้เล่นอย่างน้อย 1 คน'); return; }
      buildAssignCourtList(); document.getElementById('assign-auto').checked=false; show('assign-modal');
    }
    function buildAssignCourtList(){
      const host=document.getElementById('assign-court-list'); host.innerHTML='';
      const courts=getCourts(), players=getPlayers(), byId=mapById(players);
      courts.forEach(c=>{
        const cap=c.capacity??4, used=(c.players?.length||0), remain=Math.max(0,cap-used);
        const names=(c.players||[]).map(pid=>byId.get(pid)?.name).filter(Boolean).join(', ')||'—';
        const row=document.createElement('label'); row.className='flex items-center gap-3 border-b border-[var(--border)] py-2 cursor-pointer';
        row.innerHTML=`<input type="radio" name="assign-court" value="${c.id}" ${remain===0?'disabled':''} class="accent-indigo-400"><div class="flex-1"><div class="font-medium">${c.name} <span class="badge">ว่าง ${remain}/${cap}</span></div><div class="muted text-xs">${names}</div></div>`;
        host.appendChild(row);
      });
    }
    function confirmAssign(){
      const auto=document.getElementById('assign-auto').checked;
      const players=getPlayers(), courts=getCourts(), byId=mapById(players);
      const eligible=_assignIds.filter(id=>byId.get(id)); if(eligible.length===0){ alert('ไม่พบผู้เล่นที่เลือก'); return; }
      const beforePlayers=JSON.parse(JSON.stringify(players)); const beforeCourts=JSON.parse(JSON.stringify(courts));
      const place=(c,pId)=>{
        if(!Array.isArray(c.players)) c.players=[]; const cap=c.capacity??4;
        if(c.players.length>=cap || c.players.includes(pId)) return false;
        c.players.push(pId); const p=byId.get(pId); if(p){ p.status = (c.status==='กำลังเล่น')?'กำลังเล่น':'ในสนาม'; p.availableSince=null; }
        ensurePairs(c); recalcCourtStatus(c); return true;
      };
      let added=0;
      if(auto){
        const withSpace=()=>courts.filter(ct=>(ct.players?.length||0)<(ct.capacity??4));
        for(const pid of eligible){ let ok=false; for(const c of withSpace()){ if(place(c,pid)){ ok=true; added++; break; } } if(!ok) break; }
      }else{
        const chosen=document.querySelector('input[name="assign-court"]:checked'); if(!chosen){ alert('กรุณาเลือกสนาม หรือเปิดโหมดอัตโนมัติ'); return; }
        const target=courts.find(x=>x.id===chosen.value); if(!target){ alert('สนามไม่ถูกต้อง'); return; }
        for(const pid of eligible){ if(place(target,pid)) added++; }
      }
      if(added===0){ alert('สนามเต็ม หรือไม่มีผู้เล่นที่เพิ่มได้'); return; }
      savePlayers(players); saveCourts(courts); renderPlayers(); renderCourts(); hide('assign-modal');
      setUndo('เพิ่มผู้เล่นลงสนาม', ()=>{ savePlayers(beforePlayers); saveCourts(beforeCourts); renderPlayers(); renderCourts(); });
      showToast(`เพิ่มผู้เล่นลงสนาม ${added} คน ✓`,'เลิกทำ', triggerUndo);
    }

    /* ------- Manage court (swap + move/delete/replace) ------- */
    let _manageCtx=null; let _replaceTarget=null; let _replaceCourtId=null; let _addCourtId=null;
    function openManage(courtId){
      const courts=getCourts(), players=getPlayers(), byId=mapById(players);
      const c=courts.find(x=>x.id===courtId); if(!c) return; ensurePairs(c);
      document.getElementById('manage-court-name').textContent=c.name;

      const slots=[[null,null],[null,null]];
      if(Array.isArray(c.pairs) && c.pairs.length>=1){
        slots[0][0]=c.pairs[0]?.[0]||null; slots[0][1]=c.pairs[0]?.[1]||null;
        slots[1][0]=c.pairs[1]?.[0]||null; slots[1][1]=c.pairs[1]?.[1]||null;
      }else{
        const ids=[...(c.players||[])];
        slots[0][0]=ids[0]||null; slots[0][1]=ids[1]||null; slots[1][0]=ids[2]||null; slots[1][1]=ids[3]||null;
      }
      _manageCtx={courtId, slots};

      const drawSlot=(pairIdx, slotIdx)=>{
        const host=document.getElementById((pairIdx===0?'pairA':'pairB')+'-'+slotIdx);
        const pid=_manageCtx.slots[pairIdx][slotIdx]; const name=pid?(byId.get(pid)?.name||'—'):'—'; const skill=pid?(byId.get(pid)?.skill||'N'):'';
        host.classList.remove('ring-2','ring-indigo-400');
        host.innerHTML=`<span class="badge">#${pairIdx===0? (slotIdx===0?1:2) : (slotIdx===0?3:4)}</span> <span class="font-semibold">${name}</span> ${pid?`<span class="tag">มือ ${skill}</span>`:''}`;
      };
      drawSlot(0,0); drawSlot(0,1); drawSlot(1,0); drawSlot(1,1);

      let _pairSelect=null;
      function manageSelectSlot(pairIdx, slotIdx){
        const hostId=(pairIdx===0?'pairA':'pairB')+'-'+slotIdx;
        const host=document.getElementById(hostId);
        if(!_pairSelect){ _pairSelect={pairIdx, slotIdx}; host.classList.add('ring-2','ring-indigo-400'); return; }
        const a=_pairSelect, b={pairIdx, slotIdx};
        if(a.pairIdx===b.pairIdx && a.slotIdx===b.slotIdx){ host.classList.remove('ring-2','ring-indigo-400'); _pairSelect=null; return; }
        const beforeCourts=JSON.parse(JSON.stringify(getCourts()));
        const tmp=_manageCtx.slots[a.pairIdx][a.slotIdx];
        _manageCtx.slots[a.pairIdx][a.slotIdx]=_manageCtx.slots[b.pairIdx][b.slotIdx];
        _manageCtx.slots[b.pairIdx][b.slotIdx]=tmp;
        _pairSelect=null; autoSaveManagePairs(beforeCourts);
      }
      ['pairA-0','pairA-1','pairB-0','pairB-1'].forEach((id,i)=>{ const el=document.getElementById(id); if(el){ const p=(i<2?0:1), s=(i%2); el.onclick=()=>manageSelectSlot(p,s); }});

      function autoSaveManagePairs(beforeCourts=null){
        const courts=getCourts(); const cc=courts.find(x=>x.id===_manageCtx.courtId); if(!cc) return;
        const pairs=[];
        if(_manageCtx.slots[0][0]&&_manageCtx.slots[0][1]) pairs.push([_manageCtx.slots[0][0],_manageCtx.slots[0][1]]);
        if(_manageCtx.slots[1][0]&&_manageCtx.slots[1][1]) pairs.push([_manageCtx.slots[1][0],_manageCtx.slots[1][1]]);
        cc.pairs=pairs; ensurePairs(cc); recalcCourtStatus(cc); saveCourts(courts); renderCourts(); openManage(_manageCtx.courtId);
        if(beforeCourts){ setUndo('สลับสลอต', ()=>{ saveCourts(beforeCourts); renderCourts(); openManage(_manageCtx.courtId); }); showToast('บันทึกการสลับแล้ว ✓','เลิกทำ', triggerUndo); }
      }

      // build action list
      const list=document.getElementById('manage-list'); list.innerHTML='';
      if(!c.players||c.players.length===0){ list.innerHTML='<div class="muted">ไม่มีผู้เล่นในสนามนี้</div>'; }
      else{
        const options=courts.map(ct=>`<option value="${ct.id}" ${ct.id===c.id?'disabled':''}>${ct.name}${ct.id===c.id?' (สนามนี้)':''}</option>`).join('');
          const bulkSel=document.getElementById('bulk-move-select'); if(bulkSel){ bulkSel.innerHTML=options; }
          const bulkBtn=document.getElementById('bulk-move-btn'); if(bulkBtn){ bulkBtn.onclick=()=>{ const target=bulkSel?.value; if(!target){ alert('กรุณาเลือกสนามปลายทาง'); return;} if(target===c.id){ alert('สนามปลายทางต้องต่างจากสนามต้นทาง'); return;} bulkMoveAll(c.id, target); }; }
        c.players.forEach(pid=>{
          const p=byId.get(pid); if(!p) return;
          const row=document.createElement('div'); row.className='flex items-center gap-3 border-b border-[var(--border)] py-2';
          row.innerHTML=`
            <div class="flex-1">
              <div class="font-medium">${p.name}</div>
              <div class="muted text-xs">สถานะ: ${p.status} • มือ ${p.skill||'N'}</div>
            </div>
            <select class="soft px-2 py-1 text-sm">${options}</select>
            <button class="icon-btn" title="ย้ายไปสนามที่เลือก"><i class="fa-solid fa-right-left"></i></button>
            <button class="icon-btn" title="ลบออกจากสนาม"><i class="fa-solid fa-user-minus"></i></button>
            <button class="icon-btn" title="แทนที่ด้วยผู้เล่นว่าง"><i class="fa-solid fa-user-pen"></i></button>
          `;
          const [sel, btnMove, btnRemove, btnReplace] = [row.querySelector('select'), ...row.querySelectorAll('button')];
          btnMove.onclick = ()=> movePlayer(pid, c.id, sel.value, true);
          btnRemove.onclick = ()=> removePlayerFromCourt(pid, c.id, true);
          btnReplace.onclick = ()=> { openFreePicker(pid, c.id); };
          list.appendChild(row);
        });
      }

      show('manage-modal');
    }

    // Free picker (one declaration only)
    function openFreePicker(targetPid=null, courtId){
      _replaceTarget = targetPid; _replaceCourtId = courtId; _addCourtId = (!targetPid ? courtId : null);
      const input=document.getElementById('free-search'); input.value='';
      buildFreeList(''); show('free-picker-modal');
      input.oninput = e => buildFreeList(e.target.value.trim());
    }
    function buildFreeList(kw){
      const host=document.getElementById('free-list'); host.innerHTML='';
      const players=getPlayers();
      const free=players.filter(p=>p.status==='ว่าง').filter(p=>!kw || (p.name||'').toLowerCase().includes(kw.toLowerCase()));
      if(free.length===0){ host.innerHTML='<div class="muted text-sm">ไม่มีผู้เล่นว่างที่ตรงเงื่อนไข</div>'; return; }
      free.forEach(p=>{
        const row=document.createElement('div'); row.className='flex items-center justify-between border-b border-[var(--border)] py-2';
        row.innerHTML=`<div><span class="font-medium">${p.name}</span> <span class="badge">มือ ${p.skill||'N'}</span></div><button class="btn btn-green">เลือก</button>`;
        row.querySelector('button').onclick = ()=>{
          if(_replaceTarget){ replaceWithFree(_replaceTarget, _replaceCourtId, p.id); }
          else if(_addCourtId){ addFreeToCourt(_addCourtId, p.id); }
          hide('free-picker-modal');
        };
        host.appendChild(row);
      });
    }
    function replaceWithFree(targetPid, courtId, freePid){
      const courts=getCourts(), players=getPlayers(), byId=mapById(players);
      const c=courts.find(x=>x.id===courtId), target=byId.get(targetPid), newcomer=byId.get(freePid);
      if(!c||!target||!newcomer) return;
      if(targetPid===freePid) return;
      const beforePlayers=JSON.parse(JSON.stringify(players));
      const beforeCourts=JSON.parse(JSON.stringify(courts));
      c.players = (c.players||[]);
      if(!c.players.includes(freePid)) c.players.push(freePid);
      if(Array.isArray(c.pairs)){ c.pairs = c.pairs.map(pr=> pr.map(id=> id===targetPid ? freePid : id)); }
      c.players = c.players.filter(id=>id!==targetPid);
      if(c.waiting===targetPid) c.waiting=null;
      newcomer.status = (c.status==='กำลังเล่น') ? 'กำลังเล่น' : 'ในสนาม'; newcomer.availableSince = null;
      target.status = 'ว่าง'; target.availableSince = Date.now();
      ensurePairs(c); recalcCourtStatus(c);
      savePlayers(players); saveCourts(courts); renderPlayers(); renderCourts(); openManage(courtId);
      setUndo('แทนที่ผู้เล่น', ()=>{ savePlayers(beforePlayers); saveCourts(beforeCourts); renderPlayers(); renderCourts(); openManage(courtId); });
      showToast('แทนที่ผู้เล่นแล้ว ✓','เลิกทำ', triggerUndo);
    }
    function addFreeToCourt(courtId, freePid){
      const courts=getCourts(), players=getPlayers(), byId=mapById(players);
      const c=courts.find(x=>x.id===courtId), newcomer=byId.get(freePid);
      if(!c||!newcomer) return;
      const beforePlayers=JSON.parse(JSON.stringify(players));
      const beforeCourts=JSON.parse(JSON.stringify(courts));
      const cap=c.capacity??4; c.players=c.players||[];
      if(c.players.length>=cap){ alert('สนามเต็ม'); return; }
      if(!c.players.includes(freePid)) c.players.push(freePid);
      newcomer.status = (c.status==='กำลังเล่น') ? 'กำลังเล่น' : 'ในสนาม'; newcomer.availableSince = null;
      ensurePairs(c); recalcCourtStatus(c);
      savePlayers(players); saveCourts(courts); renderPlayers(); renderCourts(); openManage(courtId);
      setUndo('เพิ่มผู้เล่นว่างเข้าสนาม', ()=>{ savePlayers(beforePlayers); saveCourts(beforeCourts); renderPlayers(); renderCourts(); openManage(courtId); });
      showToast('เพิ่มผู้เล่นเข้าสนามแล้ว ✓','เลิกทำ', triggerUndo);
    }

    
    function bulkMoveAll(fromId, toId){
      const courts=getCourts(), players=getPlayers(), byId=mapById(players);
      const from=courts.find(x=>x.id===fromId), to=courts.find(x=>x.id===toId);
      if(!from||!to){ alert('ไม่พบสนามต้นทาง/ปลายทาง'); return; }
      const beforePlayers=JSON.parse(JSON.stringify(players));
      const beforeCourts =JSON.parse(JSON.stringify(courts));
      const cap=to.capacity??4; to.players=to.players||[];
      const ids=(from.players||[]).slice();
      if(ids.length===0){ alert('ไม่มีผู้เล่นในสนามต้นทาง'); return; }
      let moved=0;
      for(const pid of ids){
        if((to.players?.length||0)>=(to.capacity??4)) break;
        from.players=(from.players||[]).filter(x=>x!==pid);
        if(Array.isArray(from.pairs)) from.pairs=from.pairs.filter(pr=>!pr.includes(pid));
        if(from.waiting===pid) from.waiting=null; ensurePairs(from); recalcCourtStatus(from);
        if(!Array.isArray(to.players)) to.players=[]; if(!to.players.includes(pid)) to.players.push(pid);
        const p=byId.get(pid); if(p){ p.status=(to.status==='กำลังเล่น')?'กำลังเล่น':'ในสนาม'; p.availableSince=null; }
        ensurePairs(to); recalcCourtStatus(to);
        moved++;
      }
      savePlayers(players); saveCourts(courts); renderPlayers(); renderCourts(); if(_manageCtx?.courtId){ openManage(_manageCtx.courtId); }
      setUndo('ย้ายผู้เล่นทั้งหมด', ()=>{ savePlayers(beforePlayers); saveCourts(beforeCourts); renderPlayers(); renderCourts(); if(_manageCtx?.courtId){ openManage(_manageCtx.courtId); } });
      showToast(`ย้ายทั้งหมดแล้ว ${moved} คน ✓`,'เลิกทำ', triggerUndo);
    }

    function movePlayer(pid, fromId, toId, withToast=false){
      const courts=getCourts(), players=getPlayers(), byId=mapById(players);
      const from=courts.find(x=>x.id===fromId), to=courts.find(x=>x.id===toId), p=byId.get(pid);
      if(!from||!to||!p) return;
      const beforePlayers=JSON.parse(JSON.stringify(players));
      const beforeCourts=JSON.parse(JSON.stringify(courts));
      from.players=(from.players||[]).filter(x=>x!==pid);
      if(Array.isArray(from.pairs)) from.pairs=from.pairs.filter(pr=>!pr.includes(pid));
      if(from.waiting===pid) from.waiting=null; ensurePairs(from); recalcCourtStatus(from);
      if(!Array.isArray(to.players)) to.players=[]; const cap=to.capacity??4; if(to.players.length>=cap){ alert('สนามปลายทางเต็ม'); saveCourts(courts); renderCourts(); return; }
      if(!to.players.includes(pid)) to.players.push(pid);
      p.status=(to.status==='กำลังเล่น')?'กำลังเล่น':'ในสนาม'; p.availableSince=null; ensurePairs(to); recalcCourtStatus(to);
      savePlayers(players); saveCourts(courts); renderPlayers(); renderCourts(); openManage(toId);
      if(withToast){ setUndo('ย้ายผู้เล่น', ()=>{ savePlayers(beforePlayers); saveCourts(beforeCourts); renderPlayers(); renderCourts(); openManage(fromId); }); showToast('ย้ายผู้เล่นแล้ว ✓','เลิกทำ', triggerUndo); }
    }
    function removePlayerFromCourt(pid, cid, withToast=false){
      const courts=getCourts(), players=getPlayers(), byId=mapById(players);
      const c=courts.find(x=>x.id===cid), p=byId.get(pid); if(!c||!p) return;
      const beforePlayers=JSON.parse(JSON.stringify(players));
      const beforeCourts=JSON.parse(JSON.stringify(courts));
      c.players=(c.players||[]).filter(id=>id!==pid);
      if(Array.isArray(c.pairs)) c.pairs=c.pairs.filter(pr=>!pr.includes(pid));
      if(c.waiting===pid) c.waiting=null; ensurePairs(c); recalcCourtStatus(c);
      p.status='ว่าง'; p.availableSince=Date.now(); savePlayers(players); saveCourts(courts); renderPlayers(); renderCourts(); openManage(cid);
      if(withToast){ setUndo('ลบออกจากสนาม', ()=>{ savePlayers(beforePlayers); saveCourts(beforeCourts); renderPlayers(); renderCourts(); openManage(cid); }); showToast('ลบผู้เล่นออกจากสนามแล้ว ✓','เลิกทำ', triggerUndo); }
    }

    /* ------- Queue ------- */
    let _manualSel=[]; let _manualMode='create'; let _manualEditIndex=null; let _manualPairsPreview={mode:'AB_CD'};
    function renderQueue(){
      const host=document.getElementById('queue-container'); host.innerHTML='';
      const q=getQueue(), players=getPlayers(), byId=mapById(players);
      const count = q.matches?.length || 0; document.getElementById('queue-count').textContent = count;
      updateQueueBadge?.();
      if(!q.matches || q.matches.length===0){ host.innerHTML='<div class="muted">ยังไม่มีคิว</div>'; return; }
      q.matches.forEach((mt,idx)=>{
        const [[A,B],[C,D]] = mt.pairs;
        const n=id=>byId.get(id)?.name||'—', s=id=>byId.get(id)?.skill||'N';
        const row=document.createElement('div'); row.className='panel p-4';
        row.innerHTML=`
          <div class="flex items-center justify-between">
            <div class="font-semibold">คิวที่ ${idx+1}</div>
            <div class="flex gap-1">
              <button class="icon-btn" title="สลับเป็น 1–3/2–4" data-x="acbd"><i class="fa-solid fa-arrows-left-right-to-line"></i></button>
              <button class="icon-btn" title="สลับเป็น 1–4/2–3" data-x="adbc"><i class="fa-solid fa-shuffle"></i></button>
              <button class="icon-btn" title="แก้ไข" data-x="edit"><i class="fa-solid fa-pen"></i></button>
              <button class="icon-btn" title="ส่งลงสนาม" data-x="send"><i class="fa-solid fa-paper-plane"></i></button>
              <button class="icon-btn" title="ลบ" data-x="del"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
          <div class="mt-2 text-sm">
            <span class="chip">${n(A)} <span class="tag">มือ ${s(A)}</span></span>
            <span class="muted">×</span>
            <span class="chip">${n(B)} <span class="tag">มือ ${s(B)}</span></span>
            <span class="muted">เจอ</span>
            <span class="chip">${n(C)} <span class="tag">มือ ${s(C)}</span></span>
            <span class="muted">×</span>
            <span class="chip">${n(D)} <span class="tag">มือ ${s(D)}</span></span>
          </div>`;
        const [cross1,cross2,editBtn,sendBtn,delBtn]=row.querySelectorAll('.icon-btn');
        cross1.onclick=()=>{ const Q=getQueue(); const P=Q.matches[idx].pairs; const [a,b]=P[0],[c,d]=P[1]; Q.matches[idx].pairs=[[a,c],[b,d]]; saveQueue(Q); renderQueue(); showToast('สลับคู่แบบ 1–3 / 2–4 ✓'); };
        cross2.onclick=()=>{ const Q=getQueue(); const P=Q.matches[idx].pairs; const [a,b]=P[0],[c,d]=P[1]; Q.matches[idx].pairs=[[a,d],[b,c]]; saveQueue(Q); renderQueue(); showToast('สลับคู่แบบ 1–4 / 2–3 ✓'); };
        editBtn.onclick =()=> openQueueEdit(idx);
        sendBtn.onclick =()=> openQueueSendModal(idx);
        delBtn.onclick  =()=>{ const Q=getQueue(); const before=JSON.parse(JSON.stringify(Q)); Q.matches.splice(idx,1); saveQueue(Q); renderQueue(); setUndo('ลบคิว', ()=>{ saveQueue(before); renderQueue(); }); showToast('ลบคิวแล้ว ✓','เลิกทำ', triggerUndo); };
        host.appendChild(row);
      });
    }
    function buildQueueMatchesFromAvailable(){
      const players=getPlayers();
      const free=players.filter(p=>p.status==='ว่าง').sort((a,b)=>(a.availableSince??0)-(b.availableSince??0)).map(p=>p.id);
      if(free.length<4){ alert('ผู้เล่นว่างน้อยกว่า 4 คน'); return; }
      const matches=[]; for(let i=0;i+3<free.length;i+=4){ matches.push({pairs:[[free[i],free[i+1]],[free[i+2],free[i+3]]]}); }
      const before=getQueue(); saveQueue({matches}); renderQueue();
      setUndo('จัดคิวอัตโนมัติ', ()=>{ saveQueue(before); renderQueue(); });
      showToast(`สร้างคิวอัตโนมัติ ${matches.length} คิว ✓`,'เลิกทำ', triggerUndo);
    }
    function clearQueueMatches(){ const before=getQueue(); saveQueue({matches:[]}); renderQueue(); setUndo('ล้างคิว', ()=>{ saveQueue(before); renderQueue(); }); showToast('ล้างคิวแล้ว ✓','เลิกทำ', triggerUndo); }
    function openManualMatch(pre=null, mode='create', editIndex=null){
      _manualMode=mode; _manualEditIndex=(mode==='edit'?editIndex:null);
      _manualSel = (Array.isArray(pre)&&pre.length===4)? [...pre] : [];
      renderManualList(); updateManualSlots(); updateManualStage();
      show('queue-manual-modal');
      document.getElementById('btn-pair-default').onclick=()=>setManualPairs('AB_CD');
      document.getElementById('btn-pair-acbd').onclick =()=>setManualPairs('AC_BD');
      document.getElementById('btn-pair_adbc').onclick =()=>setManualPairs('AD_BC');
      document.getElementById('btn-add-match').onclick   =()=>manualAddMatch();
    }
    function openQueueEdit(idx){
      const q=getQueue(); const mt=q.matches?.[idx]; if(!mt) return;
      openManualMatch([ ...mt.pairs[0], ...mt.pairs[1] ], 'edit', idx);
      const btn=document.getElementById('btn-add-match'); btn.textContent='บันทึกคิว';
    }
    function renderManualList(){
      const host=document.getElementById('manual-list'); host.innerHTML='';
      const players=getPlayers();
      players.forEach(p=>{
        const checked = _manualSel.includes(p.id) ? 'checked' : '';
        const row=document.createElement('label'); row.className='flex items-center justify-between border-b border-[var(--border)] py-2 cursor-pointer';
        row.innerHTML=`<div class="flex items-center gap-3"><input type="checkbox" ${checked} value="${p.id}" class="accent-indigo-400"><div class="font-medium">${p.name}</div></div><div class="muted text-xs">มือ ${p.skill||'N'} • ${p.status}${p.status==='ว่าง'?` • รอ ${minutesSince(p.availableSince)} นาที`:''}</div>`;
        const cb=row.querySelector('input'); cb.onchange=(e)=>{
          const id=e.target.value;
          if(e.target.checked){ if(_manualSel.length>=4){ e.target.checked=false; return; } _manualSel.push(id); }
          else{ _manualSel = _manualSel.filter(x=>x!==id); }
          updateManualSlots(); updateManualStage();
        };
        host.appendChild(row);
      });
    }
    function updateManualSlots(){
      const cont=document.getElementById('manual-slots'); cont.innerHTML='';
      const players=getPlayers(), byId=mapById(players);
      for(let i=0;i<4;i++){
        const id=_manualSel[i]; const name=id?(byId.get(id)?.name||'—'):'—'; const skill=id?(byId.get(id)?.skill||'N'):'?';
        const el=document.createElement('div'); el.className='slot';
        el.innerHTML=`<span class="badge">#${i+1}</span><span class="font-semibold">${name}</span><span class="tag">มือ ${skill}</span>`;
        cont.appendChild(el);
      }
    }
    function updateManualStage(){
      const stage=document.getElementById('manual-stage'); stage.innerHTML='';
      const players=getPlayers(), byId=mapById(players);
      const enableBtns = _manualSel.length===4;
      ['btn-pair-default','btn-pair-acbd','btn-pair_adbc','btn-add-match'].forEach(id=>{
        const el=document.getElementById(id); if(!enableBtns) el.setAttribute('disabled',''); else el.removeAttribute('disabled');
      });
      if(!enableBtns){ stage.innerHTML='<div class="muted text-sm">เลือกให้ครบ 4 คน</div>'; return; }
      const n=_manualSel.map(id=>byId.get(id)?.name||'—');
      stage.innerHTML=`<div class="text-sm space-y-2"><div>${n[0]} <span class="muted">×</span> ${n[1]} <span class="muted">เจอ</span> ${n[2]} <span class="muted">×</span> ${n[3]}</div><div>${n[0]} <span class="muted">×</span> ${n[2]} <span class="muted">เจอ</span> ${n[1]} <span class="muted">×</span> ${n[3]}</div><div>${n[0]} <span class="muted">×</span> ${n[3]} <span class="muted">เจอ</span> ${n[1]} <span class="muted">×</span> ${n[2]}</div></div>`;
      _manualPairsPreview={mode:'AB_CD'};
    }
    function setManualPairs(mode){ _manualPairsPreview.mode=mode; }
    function manualAddMatch(){
      if(_manualSel.length!==4) return;
      const [A,B,C,D]=_manualSel;
      let pairs; if(_manualPairsPreview.mode==='AC_BD') pairs=[[A,C],[B,D]]; else if(_manualPairsPreview.mode==='AD_BC') pairs=[[A,D],[B,C]]; else pairs=[[A,B],[C,D]];
      const q=getQueue(); const before=JSON.parse(JSON.stringify(q)); q.matches=q.matches||[];
      const sameSet=(mt)=>{ const s=new Set([A,B,C,D]); const t=new Set(mt.pairs.flat()); if(s.size!==t.size) return false; for(const x of s){ if(!t.has(x)) return false; } return true; };
      if(_manualMode==='edit'){
        const i=_manualEditIndex; if(i==null||!q.matches[i]) return;
        if(q.matches.some((mt,idx)=>idx!==i&&sameSet(mt))){ alert('คิวแบบนี้มีอยู่แล้ว'); return; }
        q.matches[i].pairs=pairs; saveQueue(q); hide('queue-manual-modal'); renderQueue();
        setUndo('แก้ไขคิว', ()=>{ saveQueue(before); renderQueue(); });
        showToast('บันทึกคิวแล้ว ✓','เลิกทำ', triggerUndo);
        return;
      }
      if(q.matches.some(sameSet)){ alert('คิวชุดนี้มีอยู่แล้ว'); return; }
      q.matches.push({pairs}); saveQueue(q); renderQueue();
      _manualSel=[]; renderManualList(); updateManualSlots(); updateManualStage();
      setUndo('เพิ่มคิว', ()=>{ saveQueue(before); renderQueue(); });
      showToast('เพิ่มคิวแล้ว ✓','เลิกทำ', triggerUndo);
    }

    /* Queue send */
    let _queueSendIndex=null;
    function openQueueSendModal(idx){
      _queueSendIndex=idx; const q=getQueue(); const mt=q.matches[idx]; const players=getPlayers(), byId=mapById(players);
      const [[a,b],[c,d]]=mt.pairs; const n=id=>byId.get(id)?.name||'—';
      document.getElementById('queue-send-summary').innerHTML=`จะส่ง: <strong>${n(a)}</strong> × <strong>${n(b)}</strong> <span class="muted">เจอ</span> <strong>${n(c)}</strong> × <strong>${n(d)}</strong>`;
      const list=document.createElement('div'); list.className='space-y-2'; const courts=getCourts();
      const ok=courts.map(c=>({c,cap:c.capacity??4,used:(c.players?.length||0)})).filter(x=>x.cap-x.used>=4);
      if(ok.length===0) list.innerHTML='<div class="muted">ไม่มีสนามที่ว่าง ≥ 4</div>';
      else ok.forEach(({c,cap,used})=>{ const remain=cap-used; const el=document.createElement('label'); el.className='flex items-center gap-3 cursor-pointer'; el.innerHTML=`<input type="radio" class="accent-indigo-400" name="queue-send-court" value="${c.id}"><div class="flex-1">${c.name} <span class="badge">ว่าง ${remain}/${cap}</span></div>`; list.appendChild(el); });
      const host=document.getElementById('queue-send-court'); host.innerHTML=''; host.appendChild(list); show('queue-send-modal');
    }
    function confirmSendQueueMatch(){
      const chosen=document.querySelector('input[name="queue-send-court"]:checked'); if(!chosen){ alert('เลือกสนามก่อน'); return; }
      const courtId=chosen.value; const q=getQueue(); const before=JSON.parse(JSON.stringify(q)); const courts=getCourts(); const c=courts.find(x=>x.id===courtId); if(!c) return;
      const players=getPlayers(), byId=mapById(players); const mt=q.matches[_queueSendIndex];
      if((c.capacity??4) - (c.players?.length||0) < 4){ alert('ที่ว่างไม่พอ'); return; }
      mt.pairs.flat().forEach(pid=>{ if(!c.players.includes(pid)) c.players.push(pid); const p=byId.get(pid); if(p){ p.status=(c.status==='กำลังเล่น')?'กำลังเล่น':'ในสนาม'; p.availableSince=null; } });
      c.pairs = [ [...mt.pairs[0]], [...mt.pairs[1]] ];
      ensurePairs(c); recalcCourtStatus(c);
      q.matches.splice(_queueSendIndex,1); saveQueue(q); saveCourts(courts); savePlayers(players);
      hide('queue-send-modal'); renderCourts(); renderPlayers(); renderQueue();
      setUndo('ส่งคิวลงสนาม', ()=>{ saveQueue(before); saveCourts(courts); renderCourts(); renderQueue(); });
      showToast('ส่งคิวลงสนามแล้ว ✓','เลิกทำ', triggerUndo);
    }

    /* Forms: add court */
    document.getElementById('add-court-form').addEventListener('submit',e=>{
      e.preventDefault();
      const name=document.getElementById('court-name-input').value.trim();
      const capacity=getNumberOrZero(document.getElementById('court-capacity-input').value)||4;
      const courts=getCourts(); if(courts.some(c=>(c.name||'').toLowerCase()===name.toLowerCase())){ alert('ชื่อซ้ำ'); return; }
      const before=JSON.parse(JSON.stringify(courts));
      courts.push({id:uuid(), name, status:'ว่าง', players:[], pairs:[], waiting:null, roundNo:0, capacity});
      saveCourts(courts); hide('add-court-modal'); renderCourts(); e.target.reset();
      setUndo('เพิ่มสนาม', ()=>{ saveCourts(before); renderCourts(); });
      showToast('เพิ่มสนามแล้ว ✓','เลิกทำ', triggerUndo);
    });

    /* Export/Import */
    function openDataModal(){ show('data-modal'); document.getElementById('export-textarea').value=''; }
    function exportData(){
      const data = {
        version: 'v8',
        exportedAt: new Date().toISOString(),
        players: getPlayers(),
        courts: getCourts(),
        queue: getQueue()
      };
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `court-manager-backup-${Date.now()}.json`; a.click();
      URL.revokeObjectURL(url);
      const ta = document.getElementById('export-textarea'); if(ta) ta.value = json;
      showToast('ดาวน์โหลดไฟล์สำรองแล้ว ✓');
    }
    function importDataFile(file){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const obj = JSON.parse(e.target.result);
          if(!obj || typeof obj !== 'object') throw new Error('ไฟล์ไม่ถูกต้อง');
          const before = {players:getPlayers(), courts:getCourts(), queue:getQueue()};
          savePlayers(obj.players||[]);
          saveCourts(obj.courts||[]);
          saveQueue(obj.queue||{matches:[]});
          renderPlayers(); renderCourts(); renderQueue();
          showToast('นำเข้าข้อมูลเรียบร้อย ✓','เลิกทำ', ()=>{ savePlayers(before.players); saveCourts(before.courts); saveQueue(before.queue); renderPlayers(); renderCourts(); renderQueue(); });
        }catch(err){ alert('นำเข้าไม่สำเร็จ: '+err.message); }
      };
      reader.readAsText(file, 'utf-8');
    }

    /* Init */
    
function init(){
  try{ migrate(); }catch(e){}
  try{ renderCourts(); }catch(e){}
  try{ renderPlayers(); }catch(e){}
  try{ renderQueue(); }catch(e){}
  try{ updatePriceDisplay(); }catch(e){}
  try{ attachSortHandlers(); }catch(e){}
  try{ applyQueueSidebarState?.(); }catch(e){}
  try{ applyHistorySidebarState?.(); }catch(e){}
  try{ renderAllHistorySidebar?.(); }catch(e){}
  try{ setInterval(renderPlayers, 30000); }catch(e){}
}

    function clearAllCourts(){ if(confirm('ล้างข้อมูลทั้งหมด?')){ localStorage.removeItem('players'); localStorage.removeItem('courts'); localStorage.removeItem('queue_matches'); renderCourts(); renderPlayers(); renderQueue(); updatePriceDisplay(); showToast('ล้างข้อมูลทั้งหมดแล้ว'); } }
    init();
  </script>
</body>
</html>
